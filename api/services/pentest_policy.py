"""
Pentest Policy Service — Gestión de políticas de seguridad
"""

from api.models.pentest import PentestPolicy

# Política por defecto
DEFAULT_POLICY = PentestPolicy(
    policy_id="DEFAULT-POLICY",
    case_id="GLOBAL",
    name="Default Safe Policy",
    intensity="SAFE",
    scope={
        "domains": [],
        "ips": [],
        "cloud": [],
        "excluded": []
    },
    allowed_actions=["recon", "vuln_scan", "config_review"],
    forbidden_actions=[
        "exploit", 
        "password_bruteforce", 
        "dos", 
        "rce", 
        "sql_injection_exploitation", 
        "lateral_movement", 
        "data_exfiltration", 
        "defacement", 
        "malware_installation"
    ],
    approval_matrix={
        "LOW": False,
        "MEDIUM": True,
        "HIGH": True,
        "OFFENSIVE": True
    },
    human_approval_required=True,
    authorized_by="system",
    break_glass_mode=False,
    break_glass_justification=None
)

# In-memory policy store
_POLICY_STORE = {}

def get_active_policy(case_id: str) -> PentestPolicy:
    """
    Recupera la política activa para un caso.
    Si existe una personalizada, la retorna. Si no, retorna la default.
    """
    if case_id in _POLICY_STORE:
        return _POLICY_STORE[case_id]

    # Crear copia de la política default para este caso
    policy = DEFAULT_POLICY.model_copy(deep=True)
    policy.case_id = case_id
    return policy

def update_case_policy(policy: PentestPolicy) -> PentestPolicy:
    """Actualiza la política para un caso específico"""
    _POLICY_STORE[policy.case_id] = policy
    return policy
