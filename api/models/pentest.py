"""
MCP Pentest Models — v4.5.0
Pydantic schemas for governed autonomous pentesting
"""

from pydantic import BaseModel, Field
from typing import List, Dict, Optional, Literal
from enum import Enum
from datetime import datetime, timezone


class PentestStatus(str, Enum):
    """Estados del flujo de pentesting"""
    queued = "queued"
    planning = "planning"
    awaiting_approval = "awaiting_approval"
    executing = "executing"
    completed = "completed"
    failed = "failed"
    cancelled = "cancelled"


class PentestPhase(str, Enum):
    """Fases del pentesting (para organizar evidencia)"""
    recon = "recon"
    web = "web"
    auth = "auth"
    config = "config"
    other = "other"


class PentestRisk(str, Enum):
    """Niveles de riesgo de acciones"""
    LOW = "LOW"
    MEDIUM = "MEDIUM"
    HIGH = "HIGH"
    OFFENSIVE = "OFFENSIVE"


class PentestTask(BaseModel):
    """Una tarea individual en el plan de pentesting"""
    task_id: str = Field(..., description="Identificador único de tarea")
    agent: str = Field(..., description="Agente responsable (ej: 'red.recon')")
    tool: str = Field(..., description="Herramienta a ejecutar (ej: 'nmap', 'nuclei')")
    command: List[str] = Field(..., description="Comando a ejecutar (lista de strings)")
    reason: str = Field(default="", description="Por qué se ejecuta esta tarea")
    phase: PentestPhase = Field(default=PentestPhase.other, description="Fase del pentesting")
    risk_level: PentestRisk = Field(default=PentestRisk.LOW, description="Nivel de riesgo")
    requires_approval: bool = Field(default=False, description="Requiere aprobación humana")
    sandbox: bool = Field(default=True, description="Ejecutar en sandbox (firejail)")
    timeout: int = Field(default=300, description="Timeout en segundos")


class PentestPlan(BaseModel):
    """Plan generado por LLM Planner"""
    pentest_id: str = Field(..., description="ID único del pentesting")
    tasks: List[PentestTask] = Field(default_factory=list, description="Lista de tareas")
    escalation_required: bool = Field(default=False, description="Requiere escalación humana")
    escalation_reason: Optional[str] = Field(default=None, description="Razón de escalación")
    generated_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    expires_at: Optional[datetime] = Field(default=None)


class PentestPolicy(BaseModel):
    """Policy que define scope y límites del pentesting"""
    policy_id: str = Field(..., description="Identificador de política")
    case_id: str = Field(..., description="Caso asociado")
    name: str = Field(default="", description="Nombre legible de la policy")
    intensity: Literal["SAFE", "MODERATE", "AGGRESSIVE"] = Field(default="SAFE")
    
    # Scope
    scope: Dict[str, List[str]] = Field(
        default_factory=lambda: {"domains": [], "ips": [], "cloud": [], "excluded": []},
        description="Scope: dominios, IPs, servicios cloud y exclusiones"
    )
    
    # Acciones
    allowed_actions: List[str] = Field(
        default_factory=list,
        description="Acciones permitidas (ej: recon, vuln_scan, config_review)"
    )
    forbidden_actions: List[str] = Field(
        default_factory=list,
        description="Acciones prohibidas (ej: exploit, password_bruteforce, dos)"
    )
    
    # Aprobaciones
    approval_matrix: Dict[str, bool] = Field(
        default_factory=lambda: {"LOW": False, "MEDIUM": True, "HIGH": True, "OFFENSIVE": False},
        description="Mapa de qué risk levels requieren aprobación"
    )
    
    # Metadata
    human_approval_required: bool = Field(default=True, description="¿Requiere aprobación humana?")
    authorized_by: str = Field(default="system", description="Quién autorizó la policy")
    break_glass_mode: bool = Field(default=False, description="Modo de emergencia: permite acciones prohibidas")
    break_glass_justification: Optional[str] = Field(default=None, description="Justificación para break glass")
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    expires_at: Optional[datetime] = Field(default=None)


class PentestApproval(BaseModel):
    """Aprobación humana para ejecutar una tarea"""
    task_id: str
    approved: bool
    approved_by: str
    timestamp: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    comment: Optional[str] = Field(default=None, description="Contexto de la decisión")


class PentestJobRequest(BaseModel):
    """Solicitud para iniciar un pentesting"""
    case_id: str = Field(..., description="Caso asociado")
    policy_id: str = Field(..., description="ID de la policy a aplicar")
    targets: Dict[str, List[str]] = Field(
        default_factory=lambda: {"domains": [], "ips": [], "cloud": []},
        description="Targets específicos"
    )
    objectives: Optional[str] = Field(default=None, description="Objetivos del pentesting")
    tags: List[str] = Field(default_factory=list, description="Tags/categorías")


class PentestStatusResponse(BaseModel):
    """Respuesta de status de un pentesting"""
    pentest_id: str
    case_id: str
    policy_id: str
    status: PentestStatus
    progress_percentage: int
    current_action: Optional[str]
    action_plan: Optional[PentestPlan]
    pending_approvals: List[str] = Field(default_factory=list, description="Task IDs pendientes")
    completed_tasks: List[str] = Field(default_factory=list)
    failed_tasks: List[str] = Field(default_factory=list)
    created_at: datetime
    updated_at: datetime
    evidence_path: Optional[str]
    error: Optional[str]


class PentestRequest(BaseModel):
    """Solicitud de inicio de pentesting"""
    case_id: str = Field(..., description="ID del caso forense")
    targets: Dict[str, List[str]] = Field(
        default_factory=lambda: {"domains": [], "ips": []},
        description="Objetivos del pentest"
    )
    objectives: Optional[str] = Field(default=None, description="Objetivos específicos en lenguaje natural")
    intensity: Literal["SAFE", "MODERATE", "AGGRESSIVE"] = Field(default="SAFE", description="Intensidad del escaneo")


class ApprovalRequest(BaseModel):
    """Solicitud de aprobación de tarea"""
    pentest_id: str = Field(..., description="ID del pentest")
    task_id: str = Field(..., description="ID de la tarea a aprobar")
    approved_by: str = Field(default="user", description="Usuario que aprueba")
    comment: Optional[str] = Field(default=None, description="Comentario opcional")


class PentestTaskResult(BaseModel):
    """Resultado de una tarea ejecutada"""
    task_id: str
    tool: str
    status: str  # completed, failed
    output: Optional[str] = None
    error: Optional[str] = None
    duration_seconds: float = 0.0
    artifacts: List[str] = []


class PentestExecutionResults(BaseModel):
    """Resultados finales de la ejecución"""
    pentest_id: str
    case_id: str
    total_tasks: int
    completed_tasks: List[PentestTaskResult]
    failed_tasks: List[PentestTaskResult]
    success_rate: float
    evidence_base_path: str
    executed_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
