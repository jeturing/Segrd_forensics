# MCP Kali Forensics v4.1 - Release Notes

## ğŸš€ Overview

**v4.1** introduces a complete **hybrid execution system** for forensic tools, SOAR automation, threat correlation, and distributed agent management for Red/Blue/Purple teams.

## ğŸ¯ Key Features

### 1. ğŸ”§ Hybrid Tool Execution
Execute Kali tools locally on the MCP server or remotely on distributed agents.

**Endpoints:**
- `POST /api/v41/tools/execute` - Start tool execution
- `GET /api/v41/tools/executions` - List executions
- `GET /api/v41/tools/executions/{id}` - Get execution details
- `POST /api/v41/tools/executions/{id}/cancel` - Cancel running execution
- `WS /api/v41/tools/stream/{id}` - Real-time output streaming

**Features:**
- Parameter validation with security blacklist
- Sandbox execution with configurable timeout
- Live output streaming via WebSocket
- Automatic audit logging to timeline/evidence
- Queue management with priorities

### 2. ğŸ›¡ï¸ Agent Management (Blue/Red/Purple)
Deploy and manage distributed agents for incident response.

**Agent Types:**
- **Blue Team**: Defense, monitoring, log collection
- **Red Team**: Attack simulation, penetration testing
- **Purple Team**: Collaboration, validation, improvement

**Endpoints:**
- `POST /api/v41/agents/register` - Register new agent
- `GET /api/v41/agents` - List agents (filter by type/status)
- `POST /api/v41/agents/{id}/heartbeat` - Agent heartbeat
- `POST /api/v41/agents/{id}/dispatch` - Dispatch task to agent
- `WS /api/realtime/agents_v41` - Agent status updates

**Features:**
- Fingerprint-based authentication
- Heartbeat monitoring with auto-offline detection
- Task dispatch and result collection
- Telemetry collection (CPU, memory, disk)
- Capability-based routing

### 3. âš¡ SOAR Playbooks
Automated incident response workflows.

**Trigger Types:**
- `manual` - User-initiated
- `scheduled` - Cron-based
- `threshold` - Event count threshold
- `pattern` - Pattern matching on events

**Action Types:**
- `execute_tool` - Run forensic tool
- `create_alert` - Generate alert
- `send_notification` - Email/Slack/Teams
- `isolate_host` - Network isolation
- `block_ip` - Firewall block
- `collect_evidence` - Automated collection
- `update_case` - Case status update
- `escalate` - Escalation workflow
- `enrich_ioc` - IOC enrichment
- `create_ticket` - Ticketing integration

**Endpoints:**
- `GET/POST /api/v41/playbooks` - CRUD playbooks
- `POST /api/v41/playbooks/{id}/execute` - Start playbook
- `POST /api/v41/playbooks/executions/{id}/stop` - Stop execution
- `WS /api/v41/playbooks/stream/{id}` - Execution streaming

### 4. ğŸ” Correlation Engine
Threat detection with Sigma rules and ML heuristics.

**Detection Methods:**
- **Sigma Rules**: YAML-based detection rules
- **ML Heuristics**: Anomaly detection patterns
- **Threshold Rules**: Event count triggers
- **Pattern Matching**: Regex/string patterns

**Built-in Rules:**
- Brute force attack detection
- Port scanning detection
- C2 beacon detection
- Privilege escalation detection

**Endpoints:**
- `GET/POST /api/v41/correlation/rules` - CRUD rules
- `POST /api/v41/correlation/ingest` - Ingest events
- `GET /api/v41/correlation/alerts` - List alerts
- `GET /api/v41/correlation/statistics` - Engine stats
- `WS /api/v41/correlation/stream` - Real-time alerts

### 5. ğŸ“Š Enhanced Attack Graph
Automatic graph enrichment from tool outputs.

**Node Types:**
- `host`, `user`, `process`, `file`
- `network`, `ioc`, `alert`, `evidence`

**Edge Types:**
- `connects`, `executes`, `accesses`, `downloads`
- `communicates`, `contains`, `spawns`, `modifies`, `authenticates`

**Endpoints:**
- `GET/POST /api/v41/graph/nodes` - CRUD nodes
- `GET/POST /api/v41/graph/edges` - CRUD edges
- `POST /api/v41/graph/auto-enrich` - Auto-enrich from tool output
- `GET /api/v41/graph/search` - Search graph
- `GET /api/v41/graph/export` - Export graph (JSON/GraphML)
- `WS /api/v41/graph/stream/{case_id}` - Graph updates

## ğŸ“ New Files

### Backend Services
```
api/services/
â”œâ”€â”€ executor_engine.py    # Tool execution with security
â”œâ”€â”€ soar_engine.py        # Playbook automation
â”œâ”€â”€ correlation_engine.py # Sigma + ML detection
â”œâ”€â”€ graph_enricher.py     # Auto graph enrichment
â””â”€â”€ agent_manager.py      # Agent lifecycle management
```

### API Routes
```
api/routes/
â”œâ”€â”€ tools_v41.py     # Tool execution endpoints
â”œâ”€â”€ playbooks.py     # SOAR playbook endpoints
â”œâ”€â”€ correlation.py   # Correlation engine endpoints
â””â”€â”€ graph_v41.py     # Enhanced graph endpoints
```

### Frontend Components
```
frontend-react/src/components/
â”œâ”€â”€ SOAR/
â”‚   â””â”€â”€ PlaybookRunner.jsx    # Playbook management UI
â”œâ”€â”€ Correlation/
â”‚   â””â”€â”€ CorrelationDashboard.jsx  # Alerts dashboard
â”œâ”€â”€ Tools/
â”‚   â””â”€â”€ ToolExecutor.jsx      # Hybrid execution UI
â””â”€â”€ Agents/
    â””â”€â”€ AgentsDashboard.jsx   # Agent management UI
```

### Database
```
migrations/
â””â”€â”€ v4.1_schema.sql   # New tables for v4.1
```

## ğŸ”§ Installation

### 1. Apply Database Migration
```bash
cd /home/hack/mcp-kali-forensics
sqlite3 data/mcp_forensics.db < migrations/v4.1_schema.sql
```

### 2. Install Dependencies
```bash
source venv/bin/activate
pip install -r requirements.txt
```

### 3. Restart Service
```bash
sudo systemctl restart mcp-forensics
# Or in development:
uvicorn api.main:app --reload --host 0.0.0.0 --port 9000
```

### 4. Build Frontend
```bash
cd frontend-react
npm install
npm run build
```

## ğŸ” Security Considerations

### Parameter Validation
The executor engine includes a security blacklist to prevent command injection:
```python
BLACKLIST = [';', '&&', '||', '|', '>', '<', '`', '$(', '${', '\n', '\r']
```

### Agent Authentication
Agents are authenticated using:
- Fingerprint verification (hardware-based)
- API key hashing
- Heartbeat monitoring

### Policy Enforcement
Security policies can restrict:
- Tool execution (whitelist/blacklist)
- Agent capabilities
- Execution limits per user/hour

## ğŸ“Š API Examples

### Execute Tool
```bash
curl -X POST http://localhost:9000/api/v41/tools/execute \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "nmap",
    "parameters": {"-sV": true, "-p": "1-1000", "target": "192.168.1.1"},
    "target": "local",
    "case_id": "IR-2024-001",
    "timeout": 300,
    "stream": true
  }'
```

### Register Agent
```bash
curl -X POST http://localhost:9000/api/v41/agents/register \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_type": "blue",
    "hostname": "IR-WORKSTATION-01",
    "ip_address": "192.168.1.50",
    "os": "Windows 11",
    "capabilities": ["osquery", "velociraptor", "yara"]
  }'
```

### Create Playbook
```bash
curl -X POST http://localhost:9000/api/v41/playbooks \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Malware Triage",
    "description": "Initial malware analysis workflow",
    "trigger_type": "manual",
    "steps": [
      {"step_number": 1, "action_type": "execute_tool", "action_config": {"tool": "yara", "target": "$file_path"}},
      {"step_number": 2, "action_type": "execute_tool", "action_config": {"tool": "strings", "target": "$file_path"}},
      {"step_number": 3, "action_type": "create_alert", "action_config": {"severity": "high", "title": "Malware detected"}}
    ]
  }'
```

### Create Correlation Rule
```bash
curl -X POST http://localhost:9000/api/v41/correlation/rules \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "SSH Brute Force",
    "description": "Detects SSH brute force attempts",
    "rule_type": "sigma",
    "severity": "high",
    "rule_content": "title: SSH Brute Force\nlogsource:\n  product: linux\n  service: sshd\ndetection:\n  selection:\n    message|contains: \"Failed password\"\n  condition: selection | count() > 5\n  timeframe: 5m",
    "threshold": 5,
    "time_window": 300
  }'
```

## ğŸ”„ WebSocket Channels

| Channel | Description |
|---------|-------------|
| `execution:{id}` | Tool execution output streaming |
| `playbook:{id}` | Playbook step updates |
| `correlation_alerts` | Real-time alert notifications |
| `agents_v41` | Agent status updates |
| `graph:{case_id}` | Graph node/edge updates |
| `dashboard_v41` | Dashboard metrics |

## ğŸ“ˆ Metrics & Telemetry

The correlation engine tracks:
- Events processed per hour
- Alert generation rate
- Rule match counts
- False positive rates
- Detection latency

Access via: `GET /api/v41/correlation/statistics`

## ğŸ¨ Frontend Integration

### Import Components
```jsx
import { PlaybookRunner } from '@/components/SOAR';
import { CorrelationDashboard } from '@/components/Correlation';
import { ToolExecutor } from '@/components/Tools';
import { AgentsDashboard } from '@/components/Agents';
```

### Add Routes
```jsx
<Route path="/soar" element={<PlaybookRunner />} />
<Route path="/correlation" element={<CorrelationDashboard />} />
<Route path="/agents-v41" element={<AgentsDashboard />} />
```

## ğŸ› Troubleshooting

### Tools Not Executing
1. Check tool installation: `which nmap`
2. Verify permissions: `ls -la /opt/forensics-tools/`
3. Check logs: `tail -f logs/mcp-forensics.log | grep executor`

### Agents Not Connecting
1. Verify network connectivity
2. Check firewall rules for port 9000
3. Verify agent API key is correct
4. Check heartbeat endpoint accessibility

### Correlation Rules Not Matching
1. Verify rule syntax (Sigma YAML format)
2. Check event source is ingesting data
3. Review threshold and time window settings
4. Check rule is enabled: `is_enabled = 1`

## ğŸ“ Migration from v4.0

1. Backup existing database
2. Apply v4.1 migration script
3. Update main.py with new router imports
4. Rebuild frontend
5. Test all endpoints

---

**Version**: 4.1.0  
**Release Date**: 2025-01-XX  
**Maintainer**: MCP Kali Forensics Team
