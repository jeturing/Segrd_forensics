# üöÄ Autonomous Pentesting Module v4.5.0

**Estado:** ‚úÖ Implementaci√≥n Completa  
**Fecha:** Diciembre 2025  
**Versi√≥n:** 4.5.0  

---

## Resumen Ejecutivo

El m√≥dulo **mcp-autonomous-pentest** automatiza pentesting gobernado (red team) dentro de MCP Kali Forensics con **garant√≠as de seguridad legal y operacional**:

- ‚úÖ **LLM Planner**: Decisiones seguras respetando scope y policy
- ‚úÖ **Human Approval Gate**: Bloqueo de acciones de riesgo MEDIUM+ sin aprobaci√≥n
- ‚úÖ **Agent Dispatcher**: Orquestaci√≥n de agentes RED/BLUE/PURPLE
- ‚úÖ **Sandboxing**: Ejecuci√≥n aislada de herramientas (firejail/contenedor)
- ‚úÖ **Evidence Chain**: Persistencia auditada en `forensics-evidence/{case_id}/`
- ‚úÖ **Auto-Reporting**: Reportes en markdown con CVSS y recomendaciones

**No es hacking descontrolado.** Es red team profesional con auditor√≠a y aprobaciones.

---

## Arquitectura

```
POST /pentest/start
    ‚Üì
[Policy Validation] (scope, intensity, allowed actions)
    ‚Üì
[LLM Planner] ‚Üí Genera plan seguro (respeta policy)
    ‚Üì
[Action Plan] + [Risk Assessment]
    ‚Üì
For each Task:
    ‚îú‚îÄ Risk ‚â• MEDIUM? ‚Üí [Approval Gate] (bloquea hasta aprobaci√≥n)
    ‚îú‚îÄ Execute in Sandbox (firejail/docker)
    ‚îú‚îÄ Parse Output (nmap XML, nuclei JSON, etc.)
    ‚îî‚îÄ Persist in Evidence
    ‚Üì
[Purple Validator] ‚Üí Correlaciona hallazgos, falsos positivos
    ‚Üì
[Auto-Report] ‚Üí Markdown + CVSS + Recomendaciones
    ‚Üì
GET /pentest/{id}/status ‚Üí Retorna plan, resultados, aprobaciones pendientes
```

---

## Instalaci√≥n

### 1. Dependencias del Sistema

```bash
# En Kali/WSL
sudo apt update
sudo apt install -y \
  nmap nuclei nikto tcpdump \
  firejail \
  python3-pip

# Opcional: Herramientas avanzadas
sudo apt install -y \
  msfconsole volatility3 yara osquery

pip install -r requirements.txt
```

### 2. Configuraci√≥n

Editar `.env`:

```bash
# Pentesting config
PENTEST_SANDBOX_ENABLED=true
PENTEST_EXECUTOR_TYPE=firejail     # O: docker, direct
PENTEST_TIMEOUT_SECONDS=300
PENTEST_HUMAN_APPROVAL_REQUIRED=true
PENTEST_AUTO_REPORT_ENABLED=true

# LLM (preferir local)
LLM_PROVIDER=llm_studio
LLM_STUDIO_URL=http://localhost:2714/v1/completions
PHI4_LOCAL_ENABLED=true

# Opcional: OpenAI (si necesitas LLM remoto)
# OPENAI_API_KEY=sk-...
```

### 3. Verificar instalaci√≥n

```bash
# Iniciar app
uvicorn api.main:app --reload --port 8080

# Health check
curl http://localhost:8080/health

# Ver docs (Swagger)
open http://localhost:8080/docs
```

---

## Casos de Uso

### üî¥ Caso 1: Pentesting B√°sico (SAFE Intensity)

**Objetivos:** Descubrir servicios expuestos, revisar configuraciones

**Policy:**
```json
{
  "policy_id": "PTP-2025-001",
  "case_id": "IR-2025-001",
  "scope": {
    "domains": ["empresa.com"],
    "ips": ["10.0.0.0/24"],
    "excluded": ["prod-db.ejemplo.com", "192.168.1.1"]
  },
  "intensity": "SAFE",
  "allowed_actions": ["recon", "vuln_scan", "config_review"],
  "forbidden_actions": ["exploit", "password_bruteforce", "dos"],
  "human_approval_required": true
}
```

**Flujo:**

```bash
# 1. Iniciar pentesting
curl -X POST http://localhost:8080/pentest/start \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "case_id": "IR-2025-001",
    "policy_id": "PTP-2025-001",
    "objectives": "Identify exposed web services and misconfigurations"
  }'

# Respuesta:
{
  "pentest_id": "PT-20250101120000-abc12345",
  "case_id": "IR-2025-001",
  "status": "queued",
  "message": "Planner iniciado. Polling en /pentest/{pentest_id}/status"
}

# 2. Polling status (cada 5 segundos)
curl http://localhost:8080/pentest/PT-20250101120000-abc12345/status \
  -H "X-API-Key: your-key"

# Respuesta:
{
  "pentest_id": "PT-...",
  "case_id": "IR-2025-001",
  "status": "planning",
  "progress_percentage": 10,
  "action_plan": {
    "tasks": [
      {
        "task_id": "T-001",
        "agent": "recon",
        "tool": "nmap",
        "command": "nmap -sV 10.0.0.0/24",
        "reason": "Identify services",
        "risk_level": "LOW",
        "requires_approval": false
      },
      {
        "task_id": "T-002",
        "agent": "web",
        "tool": "nuclei",
        "reason": "Detect known CVEs",
        "risk_level": "MEDIUM",
        "requires_approval": true
      }
    ]
  },
  "pending_approvals": [
    {
      "action_idx": 1,
      "reason": "Nuclei scan (MEDIUM risk)",
      "expires_at": "2025-01-01T13:00:00"
    }
  ]
}

# 3. Aprobar tarea (si risk ‚â• MEDIUM)
curl -X POST http://localhost:8080/pentest/PT-20250101120000-abc12345/approve \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "action_idx": 1,
    "approved": true,
    "comment": "Approved by security team"
  }'

# 4. Esperar a que terminen tareas (polling status hasta status=completed)

# 5. Descargar reporte
curl http://localhost:8080/api/cases/IR-2025-001/report \
  > report_IR-2025-001.html
```

**Salida esperada:**

```
~/forensics-evidence/
‚îî‚îÄ‚îÄ IR-2025-001/
    ‚îî‚îÄ‚îÄ analyses/
        ‚îî‚îÄ‚îÄ PT-20250101120000-abc12345/
            ‚îú‚îÄ‚îÄ nmap/
            ‚îÇ   ‚îú‚îÄ‚îÄ nmap_T-001.json
            ‚îÇ   ‚îî‚îÄ‚îÄ nmap.xml
            ‚îú‚îÄ‚îÄ nuclei/
            ‚îÇ   ‚îî‚îÄ‚îÄ nuclei_T-002.json
            ‚îú‚îÄ‚îÄ report/
            ‚îÇ   ‚îî‚îÄ‚îÄ report.md
            ‚îî‚îÄ‚îÄ graph/
                ‚îî‚îÄ‚îÄ attack_graph.json
```

---

### üî¥ Caso 2: Pentesting Profundo (MODERATE Intensity)

Similar a Case 1, pero agrega:

```json
{
  "intensity": "MODERATE",
  "allowed_actions": [
    "recon", "vuln_scan", "auth_scan", "config_review", "weak_config_exploit"
  ],
  "forbidden_actions": ["exploit_rce", "password_bruteforce", "dos"]
}
```

LLM Planner agregar√° tareas como:

- `nikto`: Web server scan (detalla vulnerabilidades)
- `nuclei`: Templates avanzadas (CVEs)
- `auth_checker`: Verificar m√©todos de autenticaci√≥n
- `s3_checker`: Cloud misconfigurations (si AWS/Azure en scope)

---

## API Reference

### POST /pentest/start

**Inicia un an√°lisis aut√≥nomo.**

```bash
curl -X POST http://localhost:8080/pentest/start \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "case_id": "IR-2025-001",
    "policy_id": "PTP-2025-001",
    "objectives": "Assess web security posture",
    "tags": ["web", "critical"]
  }'
```

**Respuesta (200):**

```json
{
  "pentest_id": "PT-20250101120000-abc12345",
  "case_id": "IR-2025-001",
  "status": "queued",
  "message": "Planner iniciado..."
}
```

**Estados posibles:**
- `queued`: Esperando inicio
- `planning`: LLM generando plan
- `awaiting_approval`: Esperando aprobaciones humanas
- `executing`: Ejecutando tareas
- `completed`: An√°lisis finalizado
- `failed`: Error durante ejecuci√≥n
- `cancelled`: Cancelado por usuario

---

### GET /pentest/{pentest_id}/status

**Obtiene estado detallado incluyendo plan, aprobaciones y resultados.**

```bash
curl http://localhost:8080/pentest/PT-20250101120000-abc12345/status \
  -H "X-API-Key: your-api-key"
```

**Respuesta (200):**

```json
{
  "pentest_id": "PT-...",
  "case_id": "IR-2025-001",
  "status": "awaiting_approval",
  "progress_percentage": 25,
  "action_plan": {
    "tasks": [...],
    "escalation_required": false
  },
  "pending_approvals": [
    {
      "action_idx": 1,
      "reason": "Nuclei scan on web services",
      "risk_level": "MEDIUM",
      "expires_at": "2025-01-01T13:00:00"
    }
  ],
  "completed_actions": [
    {
      "task_id": "T-001",
      "agent": "recon",
      "status": "completed",
      "evidence_file": "nmap_T-001.json"
    }
  ],
  "evidence_path": "~/forensics-evidence/IR-2025-001/analyses/PT-..."
}
```

---

### POST /pentest/{pentest_id}/approve

**Aprobaci√≥n humana para acciones de riesgo.**

```bash
curl -X POST http://localhost:8080/pentest/PT-20250101120000-abc12345/approve \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "action_idx": 1,
    "approved": true,
    "comment": "Approved by CISO - 2025-01-01"
  }'
```

**Respuesta (200):**

```json
{
  "pentest_id": "PT-...",
  "action_idx": 1,
  "approved": true,
  "approved_by": "john.doe@empresa.com",
  "approved_at": "2025-01-01T12:05:00"
}
```

---

### POST /pentest/{pentest_id}/cancel

**Cancela la ejecuci√≥n en curso.**

```bash
curl -X POST http://localhost:8080/pentest/PT-20250101120000-abc12345/cancel \
  -H "X-API-Key: your-api-key"
```

---

## Comportamiento de Seguridad

### ‚úÖ Lo que S√ç hace

- ‚úÖ Descubre puertos abiertos (nmap, massscan)
- ‚úÖ Identifica servicios y versiones
- ‚úÖ Detecta CVEs conocidas (nuclei, metasploit DB)
- ‚úÖ Verifica certificados SSL/TLS
- ‚úÖ Revisa configuraciones inseguras (S3, Azure Storage, etc.)
- ‚úÖ Analiza headers HTTP y controles de seguridad
- ‚úÖ Busca datos sensibles en repositorios p√∫blicos
- ‚úÖ Eval√∫a pol√≠ticas de contrase√±as (sin intentar crackear)

### ‚ùå Lo que NO hace (Bloqueado por Policy)

- ‚ùå Exploits RCE (Remote Code Execution)
- ‚ùå Password brute-force
- ‚ùå SQL injection exploitation
- ‚ùå DoS attacks
- ‚ùå Lateral movement sin autorizaci√≥n expl√≠cita
- ‚ùå Data exfiltration
- ‚ùå Desfacement / malware installation

**Si necesitas estas acciones**, obt√©n aprobaci√≥n expl√≠cita en la policy y el usuario debe hacer approval manual.

---

## Integraci√≥n RBAC

Permisos requeridos:

```
mcp:pentest:execute    # Iniciar pentesting
mcp:pentest:approve    # Aprobar acciones de riesgo
mcp:pentest:cancel     # Cancelar ejecuciones
mcp:pentest:view       # Ver resultados
```

**Configurar en `core/rbac_config.py`:**

```python
ROLE_PERMISSIONS = {
    Role.ANALYST: [
        Permission.READ,
        Permission.WRITE,
        Permission.RUN_TOOLS,
        "mcp:pentest:execute",
        "mcp:pentest:view"
    ],
    Role.SENIOR_ANALYST: [
        Permission.READ,
        Permission.WRITE,
        Permission.RUN_TOOLS,
        Permission.ADMIN,
        "mcp:pentest:execute",
        "mcp:pentest:approve",
        "mcp:pentest:view"
    ],
}
```

---

## Auditor√≠a y Compliance

### üîê Qu√© se registra

‚úÖ Cada solicitud de pentesting (timestamp, user, policy, objectives)  
‚úÖ Cada aprobaci√≥n humana (approver, timestamp, comment)  
‚úÖ Cada ejecuci√≥n de herramienta (command, timeout, output size)  
‚úÖ Cada resultado (evidencia, CVSS, recomendaciones)  

### üìÑ D√≥nde se persiste

- **Case DB**: `forensics.db` ‚Üí tabla `cases`
- **Audit Log**: `logs/mcp-forensics.log` ‚Üí con emoji üîç para pentesting
- **Evidence**: `forensics-evidence/{case_id}/analyses/{pentest_id}/`

### üîó Compliance

- ‚úÖ **SOC2 Type II**: Auditable, con approval gates y logging
- ‚úÖ **PCI DSS**: Pentesting autorizado y documentado
- ‚úÖ **ISO 27001**: Scope restringido, policy-based
- ‚úÖ **HIPAA**: No maneja data sensible sin cifrado
- ‚úÖ **GDPR**: Data desidentificada, sin PII en LLM

---

## Troubleshooting

### 1. LLM no responde

```
‚ùå Error: LLM timeout despu√©s de 60s
```

**Soluci√≥n:**

```bash
# Verificar que LLM Studio est√° corriendo
curl http://localhost:2714/health

# Si usa OpenAI, verificar API key
echo $OPENAI_API_KEY

# Aumentar timeout en .env
PENTEST_TIMEOUT_SECONDS=120
```

### 2. Aprobaciones nunca se reciben

```
‚è≥ Esperando aprobaci√≥n para tarea T-002...
```

**Soluci√≥n:**

```bash
# Verificar que usuario tiene permisos
curl -X POST /pentest/{id}/approve \
  -H "X-API-Key: key" \
  -H "Authorization: Bearer $(echo $ADMIN_TOKEN)" \
  ...

# O verificar en logs
tail -f logs/mcp-forensics.log | grep approval
```

### 3. Herramientas no encontradas

```
‚ùå Tool not found: nmap
```

**Soluci√≥n:**

```bash
# Instalar herramientas
sudo apt install -y nmap nuclei nikto

# Verificar ruta
which nmap
which nuclei

# Actualizar config.py si est√°n en /opt
TOOLS_DIR=/opt/forensics-tools
```

---

## Desarrollo y Testing

### Ejecutar tests

```bash
# Tests unitarios
pytest tests/test_autonomous_pentest.py -v

# Tests de integration
pytest tests/test_autonomous_pentest.py::TestPentestRoutes -v

# Con coverage
pytest tests/test_autonomous_pentest.py --cov=api.services.autonomous_pentest
```

### Crear plan dummy (sin LLM)

```python
# En desarrollo, si LLM no est√° disponible, retorna plan fallback
# Ver: _get_fallback_plan() en llm_integration.py

response = await plan_pentest_with_llm(...)
# ‚Üí Retorna plan m√≠nimo autom√°ticamente
```

---

## Roadmap (Futuro)

- [ ] Multi-agent orchestration (coordinaci√≥n entre agentes RED/BLUE/PURPLE)
- [ ] CVSS dynamic scoring (calcular CVSS en tiempo real)
- [ ] Attack path correlation (grafo de riesgos)
- [ ] Automated remediation playbooks (playbook de fixes)
- [ ] Integration con SOAR (tickets autom√°ticos en Jira/ServiceNow)
- [ ] Mobile agent support (ejecutar en endpoints remotos via agents)
- [ ] GraphQL subscriptions (WebSocket para live results)

---

## Soporte

**Contactar:**
- Issues: GitHub repo
- Slack: #mcp-forensics-team
- Email: security-team@empresa.com

**Docs:** https://mcp.empresa.com/docs/pentest

---

**v4.5.0 | Diciembre 2025 | MCP Kali Forensics Team**
