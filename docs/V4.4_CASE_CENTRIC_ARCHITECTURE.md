# MCP Kali Forensics v4.4 - Case-Centric Architecture

## üìã Resumen

La versi√≥n 4.4 introduce una arquitectura centrada en casos donde **TODAS las operaciones forenses est√°n vinculadas obligatoriamente a un caso (case_id)**.

### Caracter√≠sticas Principales

1. **CaseContextManager** - Gestor central de contexto de caso
2. **ProcessManager** - Procesos persistentes que sobreviven a sesiones
3. **CaseContextMiddleware** - Middleware que valida case_id en endpoints
4. **Frontend Unificado** - CaseContextProvider en React

---

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Frontend React                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ           CaseContextProvider                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - currentCase      - selectCase()               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - caseList         - createCase()               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - hasActiveCase()  - getCaseId()                ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                          ‚îÇ                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇThreatHunting ‚îÇ  ‚îÇ  Timeline    ‚îÇ  ‚îÇ   Reports    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  (case_id)   ‚îÇ  ‚îÇ  (case_id)   ‚îÇ  ‚îÇ  (case_id)   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                    API Requests
                           ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Backend FastAPI                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ         CaseContextMiddleware                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Protected paths: /hunting, /timeline, /agents,  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                   /investigation, /reports       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                          ‚îÇ                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ              CaseContextManager                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - set_context()    - get_context()               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - require_context() - validate_case()           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - _sessions cache   - _case_cache               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                          ‚îÇ                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ              ProcessManager                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - create_process()  - complete_process()         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - update_progress() - recover_processes()       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  SQLite: forensics_processes.db                   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ Archivos Nuevos/Modificados

### Core (Nuevo)
- `/core/context_manager.py` - CaseContextManager singleton
- `/core/process_manager.py` - ProcessManager con SQLite

### Middleware (Nuevo)
- `/api/middleware/case_context.py` - CaseContextMiddleware

### Backend (Modificado)
- `/api/main.py` - Imports y endpoints de contexto
- `/api/services/hunting.py` - case_id obligatorio
- `/api/services/timeline.py` - case_id obligatorio
- `/api/services/reports.py` - case_id obligatorio
- `/api/services/agent_manager.py` - case_id en assign_task
- `/api/routes/hunting.py` - Pasa case_id
- `/api/routes/active_investigation.py` - case_id obligatorio en todo

### Frontend (Nuevo/Modificado)
- `/frontend-react/src/context/CaseContext.jsx` - CaseContextProvider
- `/frontend-react/src/components/CaseHeader.jsx` - Header con selector
- `/frontend-react/src/App.jsx` - Wraps con CaseContextProvider
- `/frontend-react/src/components/ThreatHunting/ThreatHuntingPage.jsx` - v4.4
- `/frontend-react/src/components/Timeline/TimelinePage.jsx` - v4.4
- `/frontend-react/src/components/Reports/ReportsPage.jsx` - v4.4

---

## üîß Uso

### Frontend - Acceder al Contexto de Caso

```jsx
import { useCaseContext } from '../context/CaseContext';

const MyComponent = () => {
  const { 
    currentCase,
    hasActiveCase,
    getCaseId,
    selectCase,
    createCase,
    registerActivity 
  } = useCaseContext();
  
  const handleAction = async () => {
    if (!hasActiveCase()) {
      alert('Selecciona un caso primero');
      return;
    }
    
    const caseId = getCaseId();
    registerActivity('action_performed', { details: '...' });
    
    // Llamar API con case_id
    await api.post('/endpoint', { case_id: caseId, ... });
  };
  
  return (
    <div>
      {hasActiveCase() ? (
        <p>Caso activo: {currentCase.name}</p>
      ) : (
        <p>Sin caso seleccionado</p>
      )}
    </div>
  );
};
```

### Backend - Requerir case_id

```python
from core.context_manager import case_context

# En route handler
@router.post("/some-action")
async def some_action(
    case_id: str = Query(..., description="ID del caso - OBLIGATORIO")
):
    # case_id ya validado por middleware
    ...
```

### Backend - Procesos Persistentes

```python
from core.process_manager import process_manager

# Crear proceso
process = process_manager.create_process(
    process_id="scan-001",
    case_id="IR-2025-001",
    process_type="yara_scan",
    description="Escaneo YARA completo"
)

# Actualizar progreso
process_manager.update_progress("scan-001", 50, "Escaneando sistema...")

# Completar
process_manager.complete_process("scan-001", result={"findings": 5})

# Recuperar procesos tras reinicio
recovered = await process_manager.recover_processes()
```

---

## üöÄ Endpoints Nuevos

### Contexto de Caso
```
GET  /api/context/current    - Obtener contexto actual
POST /api/context/set        - Establecer caso activo
```

### Procesos
```
GET  /api/processes                     - Listar procesos activos
GET  /api/processes/{process_id}        - Detalle de proceso
DELETE /api/processes/{process_id}      - Cancelar proceso
```

### Investigaci√≥n Activa (Actualizados)
```
GET  /active-investigation/results/{case_id}  - Resultados por caso
GET  /active-investigation/stats/{case_id}    - Estad√≠sticas por caso
POST /active-investigation/execute            - Requiere case_id
POST /active-investigation/network-capture/start - Requiere case_id
POST /active-investigation/memory-dump/request   - Requiere case_id
GET  /active-investigation/command-history/{agent_id}?case_id=... - Requiere case_id
```

---

## ‚ö†Ô∏è Breaking Changes

1. **case_id ahora es OBLIGATORIO** en:
   - `/hunting/execute`
   - `/hunting/execute/custom`
   - `/timeline/*`
   - `/reports/generate`
   - `/active-investigation/*`

2. **Frontend requiere CaseContextProvider** - Todos los componentes forenses necesitan estar bajo este provider.

3. **Datos hardcodeados eliminados** - Ya no hay `case_id: 'IR-2025-001'` por defecto.

---

## üîê Validaci√≥n de Caso

El middleware valida autom√°ticamente:
- `case_id` en query params
- `case_id` en body JSON
- Rutas protegidas: `/hunting`, `/timeline`, `/agents`, `/investigation`, `/reports`

Rutas excluidas:
- `/health`
- `/api/context/*`
- `/api/processes`
- `/cases` (CRUD de casos)
- `/docs`, `/openapi.json`

---

## üìä Base de Datos de Procesos

SQLite: `forensics_processes.db`

```sql
CREATE TABLE forensics_processes (
    process_id TEXT PRIMARY KEY,
    case_id TEXT NOT NULL,
    process_type TEXT NOT NULL,
    status TEXT DEFAULT 'running',
    progress INTEGER DEFAULT 0,
    description TEXT,
    started_at TEXT,
    updated_at TEXT,
    completed_at TEXT,
    result TEXT,
    error TEXT
);
```

---

## üéØ Flujo de Trabajo T√≠pico

1. **Usuario abre la app** ‚Üí Ve selector de caso
2. **Selecciona/Crea caso** ‚Üí `CaseContextProvider.selectCase()`
3. **Navega a m√≥dulo** ‚Üí CaseHeader muestra caso activo
4. **Ejecuta acci√≥n** ‚Üí API recibe `case_id` obligatorio
5. **Proceso largo** ‚Üí ProcessManager rastrea persistentemente
6. **Usuario cierra navegador** ‚Üí Proceso sigue corriendo
7. **Usuario regresa** ‚Üí ProcessManager recupera estado

---

## üìà Migraci√≥n desde v4.3

1. Actualizar imports en componentes React
2. Envolver App con `CaseContextProvider`
3. Reemplazar `caseId` hardcodeado con `getCaseId()`
4. Agregar validaci√≥n `hasActiveCase()` antes de operaciones
5. Actualizar llamadas API para incluir `case_id`

---

**Fecha**: 2025-01-XX  
**Versi√≥n**: 4.4.0  
**Autor**: MCP Kali Forensics Team
