# üõ°Ô∏è Plan de Implementaci√≥n v4.5.0 - v4.6.0

Este documento detalla el plan t√©cnico ejecutable para las pr√≥ximas versiones del MCP Kali Forensics.

---

# üü° **MEDIUM PRIORITY ‚Äì Desarrollo Detallado**

---

# 1. **Nueva UI para Attack Graph (v4.5.0)**

El objetivo es reconstruir el grafo para que funcione como **Microsoft Sentinel**: nodos din√°micos, relaciones, foco en el atacante, IOC linking, filtrado por caso y evidencia.

## üéØ **Objetivos**

* Visualizaci√≥n de nodos: **usuarios, endpoints, IPs, procesos, correos, tokens OAuth, IOCs**.
* Relaciones din√°micas basadas en la DB: **auth ‚Üí download ‚Üí communicate ‚Üí modify ‚Üí spawn ‚Üí emailRule ‚Üí loginRisky**.
* Renderizado 100% WebGL para soportar grafos grandes.
* Acciones sobre nodos:
  * Ver evidencia
  * Marcar como FP/TP
  * Expandir relaciones
  * Generar resumen LLM

## üß© **Tecnolog√≠as**

* **Cytoscape.js** (preferido) para performance + extensiones.
* **WebSocket** para actualizaciones del grafo en tiempo real.
* **Backend v4.4.1** ya cuenta con `/graph/*` endpoints listos.

## üìê **UI / UX**

### Panel izquierdo
* Filtros por nodo (user, host, process, IOC, file, email).
* Filtros por severidad.
* Lista de eventos del timeline correlacionados.

### Panel central (Grafo)
* Zoom din√°mico
* Layout autom√°tico (ForceAtlas2 / Cola)
* Colores por riesgo
* √çconos por tipo de entidad

### Panel derecho
* Propiedades del nodo
* Evidencias asociadas
* Bot√≥n **‚ÄúAnalizar con IA‚Äù**
* Acciones SOAR

## üõ†Ô∏è **Tareas**

* [ ] Crear componente React `AttackGraph.jsx`
* [ ] Integrar Cytoscape + layouts
* [ ] Conectar a API `/graph/{case_id}`
* [ ] WS real-time para nuevos nodos/edges
* [ ] Crear panel de propiedades din√°mico
* [ ] Integrar LLM para explicaci√≥n del grafo

## ‚úîÔ∏è **Criterios de aceptaci√≥n**

* Renderiza +200 nodos con fluidez
* Interacci√≥n fluida (<16ms frame time)
* WS empuja nuevas relaciones sin recargar
* Export Graph JSON/GraphML

---

# 2. **Integrar an√°lisis LLM avanzado para casos complejos (v4.5.0)**

Actualmente el sistema usa LLMs para clasificaci√≥n de severidad y recomendaciones b√°sicas.
El upgrade apunta a an√°lisis **profundo, correlacional y multi-evidencia**.

## üéØ Objetivos

* Construir un pipeline de an√°lisis forense multi-evidencia.
* Cada caso tendr√° un **‚ÄúContext Pack‚Äù** con:
  * Logs
  * Evidencias
  * Hallazgos
  * Grafo
  * Timeline
* El LLM debe poder:
  * Detectar patrones de MITRE
  * Explicar cadenas de ataque
  * Producir un reporte ejecutivo
  * Proponer acciones SOAR espec√≠ficas

## üß© Pipeline propuesto

```
[case_id] ‚Üí build_context() ‚Üí compress_context() ‚Üí LLM Studio
                                             ‚Üë
                                     (phi-4 fallback)
```

## üõ†Ô∏è Tareas

* [ ] Crear `case_context_builder.py`
* [ ] Agregar embeddings opcionales (si RAG se habilita)
* [ ] Consumir grafo / timeline / tools outputs
* [ ] Prompt avanzado de 5 secciones (IR taxonomy)
* [ ] Integrar con `/llm/analyze`

## ‚úîÔ∏è Criterios de aceptaci√≥n

* El LLM genera un resumen de caso coherente con >90% de precisi√≥n.
* Identifica cadena ATT&CK
* Resume el ataque en lenguaje t√©cnico y directivo
* Devuelve recomendaciones accionables

---

# 3. **Optimizar LoggingQueue con compresi√≥n Zstd (v4.5.0)**

El streaming actual es estable, pero en investigaciones grandes puede generar demasiado tr√°fico WS.

## üéØ Objetivo

Reducir latencia y peso de mensajes WS, aumentando throughput del logging-worker.

## ‚úîÔ∏è Mejoras previstas

### A) Comprimir chunks de logs con **zstd** antes de enviarlos por Redis
* Ratio esperado: 70‚Äì90% reducci√≥n
* Ideal para vol√∫menes grandes (Sparrow/Hawk)

### B) Implementar **batching adaptativo**
* Si hay mucho tr√°fico ‚Üí agrupar mensajes
* Si hay poco tr√°fico ‚Üí enviar inmediato

### C) WS client (frontend)
* Descomprimir en el navegador (lib zstd-js)
* Renderizado incremental

## üõ†Ô∏è Tareas

* [ ] A√±adir `python-zstandard`
* [ ] Envolver mensajes Redis/WS
* [ ] A√±adir header `compressed:true`
* [ ] Descompresi√≥n en frontend
* [ ] Medir latencia total

## ‚úîÔ∏è Criterios de aceptaci√≥n

* 50‚Äì80% menos tr√°fico WS
* Logs no se ven afectados en tiempo real
* Sin ruptura de backward compatibility

---

# üü£ **LOW PRIORITY ‚Äì Desarrollo Detallado**

---

# 4. **Multi-Model LLM (v4.6.0)**

Extender el LLMProviderManager para permitir varios modelos por tarea:

### Ejemplo:

| Tarea                   | Modelo          | Objetivo        |
| ----------------------- | --------------- | --------------- |
| Clasificaci√≥n hallazgos | phi-4-mini      | r√°pido          |
| Resumen ejecutivo       | phi-4           | calidad         |
| Explicaci√≥n t√©cnica     | mcp-forensic-xl | contexto amplio |
| Playbooks SOAR          | phi-4-strategic | instrucciones   |

## Modelo de enrutamiento

```python
llm_manager.generate(task="summary", ...)
llm_manager.generate(task="soar_action", ...)
```

## Tareas

* [ ] Enriquecer config `.env` con mapping modelo‚Üítarea
* [ ] A√±adir router interno de modelos
* [ ] Crear dashboard UI para seleccionar modelo por funci√≥n

---

# 5. **RAG Forense por Caso (v4.6.0)**

Construir una base de conocimiento por caso (`case_context/embeddings`).

### Fuentes
* Timeline
* Evidencias
* Outputs de herramientas
* Nodos del grafo
* Hallazgos

### Flujo RAG
```
case_id ‚Üí embeddings ‚Üí vector search ‚Üí LLM ‚Üí respuesta espec√≠fica al caso
```

## Tareas

* [ ] Implementar `FAISS` local
* [ ] Crear `case_ingestor.py`
* [ ] Construir embeddings por evidencia
* [ ] Integraci√≥n con LLMProvider

---

# 6. **SOAR con Aprendizaje Continuo (v4.6.0 ‚Äì v4.7.0)**

El sistema aprende de casos anteriores para recomendar mejores acciones.

## Capacidades
* Score din√°mico de efectividad por playbook
* Ajuste autom√°tico del orden de pasos
* Aprendizaje basado en outcomes reales de cada caso

## Tareas

* [ ] Crear tabla `soar_outcomes`
* [ ] Track de ‚Äú√©xito‚Äù por acci√≥n (block, isolate, enrich, hunt)
* [ ] Calcular ponderaciones con regresi√≥n simple
* [ ] Ajustar din√°micamente los playbooks en runtime

---

# üöÄ **Resumen Ejecutable**

| Funci√≥n               | Entrega  | Tipo              |
| --------------------- | -------- | ----------------- |
| Nueva UI Attack Graph | v4.5.0   | React + Cytoscape |
| An√°lisis LLM avanzado | v4.5.0   | Backend LLM       |
| LoggingQueue + zstd   | v4.5.0   | Infra/Backend     |
| Multi-model LLM       | v4.6.0   | IA                |
| RAG por caso          | v4.6.0   | IA + Backend      |
| SOAR con aprendizaje  | v4.6‚Äì4.7 | IA + SOAR Engine  |
