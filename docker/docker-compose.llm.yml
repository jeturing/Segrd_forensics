

services:
  # ========================================
  # Ollama LLM Service (CPU Mode for macOS)
  # ========================================
  ollama:
    image: ollama/ollama:latest
    container_name: mcp-forensics-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_ORIGINS=*
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    # Healthcheck disabled - Ollama image doesn't have curl/wget
    # healthcheck:
    #   test: ["CMD-SHELL", "wget -q --spider http://localhost:11434/api/tags || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s
    networks:
      - forensics_network

  # ========================================
  # PostgreSQL with Multi-Tenancy Support
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: mcp-forensics-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-forensics}
      POSTGRES_USER: ${POSTGRES_USER:-forensics}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-forensics_secure_pass}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_tenants.sql:/docker-entrypoint-initdb.d/10-init_tenants.sql:ro
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-forensics}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - forensics_network

  # ========================================
  # Redis for Caching & Agent Coordination
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: mcp-forensics-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - forensics_network

  # ========================================
  # FastAPI Backend with Multi-Tenancy
  # ========================================
  mcp-forensics:
    build:
      context: .
      dockerfile: Dockerfile.optimized
    container_name: mcp-forensics-api
    restart: unless-stopped
    ports:
      - "8888:8888"
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-forensics}:${POSTGRES_PASSWORD:-forensics_secure_pass}@postgres:5432/${POSTGRES_DB:-forensics}
      
      # Redis
      REDIS_URL: redis://redis:6379/0
      
      # LLM Configuration
      OLLAMA_URL: http://ollama:11434
      LLM_MODEL_BASIC: tinyllama
      LLM_MODEL_MEDIUM: phi4
      LLM_MODEL_FULL: ${LLM_REMOTE_MODEL:-claude-3-5-sonnet}
      LLM_REMOTE_API_KEY: ${LLM_REMOTE_API_KEY:-}
      LLM_REMOTE_API_URL: ${LLM_REMOTE_API_URL:-}
      
      # Multi-Tenancy
      ENABLE_MULTI_TENANCY: "true"
      TENANT_ID_PREFIX: Jeturing
      DEFAULT_TENANT: ${DEFAULT_TENANT:-Jeturing_00000000-0000-0000-0000-000000000000}
      
      # Autonomous Agents
      ENABLE_AUTONOMOUS_AGENTS: "true"
      AGENT_MAX_PARALLEL: "5"
      AGENT_TIMEOUT: "300"
      
      # Security
      RBAC_ENABLED: "true"
      API_KEY: ${API_KEY:-change-this-secure-key}
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-min-32-chars}
      JETURING_CORE_API_KEY: ${JETURING_CORE_API_KEY:-dev-key-placeholder}
      
      # HexStrike AI (Red Team)
      HEXSTRIKE_ENABLED: ${HEXSTRIKE_ENABLED:-false}
      HEXSTRIKE_BASE_URL: ${HEXSTRIKE_BASE_URL:-http://hexstrike-ai:8888}
      HEXSTRIKE_API_KEY: ${HEXSTRIKE_API_KEY:-}
      HEXSTRIKE_TIMEOUT: ${HEXSTRIKE_TIMEOUT:-60}
      
      # Stripe (Billing)
      STRIPE_ENABLED: ${STRIPE_ENABLED:-false}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      
      # Cloudflare Tunnel (Production)
      CLOUDFLARE_TUNNEL_ENABLED: ${CLOUDFLARE_TUNNEL_ENABLED:-false}
      CLOUDFLARE_TUNNEL_NAME: ${CLOUDFLARE_TUNNEL_NAME:-forensics-mcp}
      BASE_DOMAIN: ${BASE_DOMAIN:-localhost}
      
      # Debug & Evidence
      DEBUG: ${DEBUG:-false}
      MAX_UPLOAD_SIZE: "100MB"
      EVIDENCE_DIR: /var/evidence
    volumes:
      - evidence_data:/var/evidence
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - forensics_network

  # ========================================
  # Nginx Reverse Proxy (Subdomain Routing)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: mcp-forensics-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - mcp-forensics
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - forensics_network

networks:
  forensics_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  ollama_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  evidence_data:
    driver: local
