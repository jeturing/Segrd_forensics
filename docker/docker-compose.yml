services:
  mcp-forensics:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcp-main:latest
    container_name: mcp-kali-forensics
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      # API Configuration
      - API_KEY=ac-e0ck-0wdkq-0aca
      - DEBUG=false
      
      # Jeturing CORE
      - JETURING_CORE_ENABLED=true
      - JETURING_CORE_URL=
      - JETURING_CORE_API_KEY=
      
      # Microsoft 365
      - M365_TENANT_ID=
      - M365_CLIENT_ID=
      - M365_CLIENT_SECRET=
      
      # Tailscale
      - TAILSCALE_ENABLED=false
      - TAILSCALE_AUTH_KEY=
      
      # HIBP
      - HIBP_API_KEY=
      - HIBP_ENABLED=false
      
      # Dehashed
      - DEHASHED_API_KEY=
      - DEHASHED_ENABLED=false
      
      # LLM Configuration
      - LLM_PROVIDER=ollama
      - OLLAMA_ENABLED=true
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3.2
      - OLLAMA_TIMEOUT=180
      - LLM_STUDIO_URL=http://100.101.115.5:2714/v1
      - LLM_STUDIO_TIMEOUT=120
      
      # Database - PostgreSQL recommended for production
      - DATABASE_URL=postgresql+asyncpg://forensics:1212lne1ne12090d12@postgres:5432/forensics
      # For SQLite mode (development only): DATABASE_URL=sqlite+aiosqlite:///./forensics.db
      
      # Redis
      - REDIS_URL=redis://redis:6379/0
    
    volumes:
      # Evidencia persistente
      - evidence:/var/evidence
      
      # Logs persistentes
      - logs:/var/log/mcp-forensics
      
      # Base de datos
      - db:/app/data
      
      # Configuración personalizada
      - ./config:/app/config:ro
      
      # Código fuente (desarrollo - hot reload)
      - ./api:/app/api:ro
      - ./core:/app/core:ro
    
    networks:
      - forensics-net
      #- jeturing-core-net
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    cap_add:
      # Capacidades necesarias para análisis forense
      - NET_ADMIN
      - SYS_PTRACE
    
    security_opt:
      - no-new-privileges:true
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    labels:
      - "com.jeturing.service=mcp-forensics"
      - "com.jeturing.type=mcp"
      - "com.jeturing.version=1.0.0"

  # PostgreSQL Database (recommended for production)
  postgres:
    image: postgres:16-alpine
    container_name: mcp-forensics-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=forensics
      - POSTGRES_USER=forensics
      - POSTGRES_PASSWORD=1212lne1ne12090d12
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/backup_postgres.sh:/usr/local/bin/backup.sh:ro
    ports:
      - "5432:5432"  # Exponer puerto para desarrollo local
    networks:
      - forensics-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forensics"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Remove profiles to make it default (not optional)
    # For SQLite-only mode, comment out this service

  # Redis for caching and task queues (recommended for production)
  redis:
    image: redis:7-alpine
    container_name: mcp-forensics-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - forensics-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    # Remove profiles to make it default (not optional)

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcp-main:latest
    container_name: mcp-forensics-api
    env_file:
      - .env
    restart: unless-stopped
    ports:
      - "8888:9000"
    volumes:
      - ./evidence:/var/evidence
    environment:
      - ENV=production
      - DATABASE_URL=postgresql://forensics:1212lne1ne12090d12@postgres:5432/forensics
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=forensics
      - POSTGRES_USER=forensics
      - POSTGRES_PASSWORD=1212lne1ne12090d12
      - LLM_PROVIDER=ollama
      - OLLAMA_ENABLED=true
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3.2
    networks:
      - forensics-net
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  logging-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.logging-worker
    image: mcp-logging-worker:latest
    environment:
      - LOG_LEVEL=info

  ws-router:
    build:
      context: .
      dockerfile: docker/Dockerfile.ws-router
    image: mcp-ws-router:latest
    # ports:
    #   - "9000:9000" # Conflicts with mcp-forensics

  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    # No deploy limits
    container_name: ollama
    networks:
      - forensics-net
  
  # Per-agent Ollama instances (CPU-only) - each uses a separate data volume and port
  ollama-agent-agent1:
    image: ollama/ollama
    container_name: ollama-agent-agent1
    ports:
      - "11435:11434"
    volumes:
      - ollama-agent1:/root/.ollama
    environment:
      - OLLAMA_HOST=http://0.0.0.0:11434
    # No deploy limits

  ollama-agent-agent2:
    image: ollama/ollama
    container_name: ollama-agent-agent2
    ports:
      - "11436:11434"
    volumes:
      - ollama-agent2:/root/.ollama
    environment:
      - OLLAMA_HOST=http://0.0.0.0:11434
    # No deploy limits

  ollama-agent-agent3:
    image: ollama/ollama
    container_name: ollama-agent-agent3
    ports:
      - "11437:11434"
    volumes:
      - ollama-agent3:/root/.ollama
    environment:
      - OLLAMA_HOST=http://0.0.0.0:11434
    # No deploy limits

  # Nginx Web Server - Sirve frontend React y proxy a API
  nginx:
    image: nginx:alpine
    container_name: mcp-forensics-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Configuración de nginx
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      
      # Frontend React (build estático)
      - ./nginx/html:/usr/share/nginx/html:ro
      
      # Certificados SSL (opcional)
      - /opt/forensics/ssl:/etc/nginx/ssl:ro
      
      # Logs
      - ./logs/nginx:/var/log/nginx
    networks:
      - forensics-net
    depends_on:
      - backend
      - postgres
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.jeturing.service=mcp-forensics-nginx"
      - "com.jeturing.type=web-server"

volumes:
  evidence:
    driver: local
  logs:
    driver: local
  db:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  ollama:
    driver: local
  ollama-agent1:
    driver: local
  ollama-agent2:
    driver: local
  ollama-agent3:
    driver: local

networks:
  forensics-net:
    driver: bridge
#  jeturing-core-net:
#    external: true
#    name: jeturing-core-network
