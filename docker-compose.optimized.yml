version: '3.8'

# Docker Compose configuration with optimized image
# Use this for production deployments

services:
  mcp-forensics:
    build:
      context: .
      dockerfile: Dockerfile.optimized
      cache_from:
        - mcp-forensics:latest
    image: mcp-forensics:optimized
    container_name: mcp-kali-forensics
    restart: unless-stopped
    ports:
      - "8080:8888"
    environment:
      # API Configuration
      - API_KEY=${API_KEY}
      - DEBUG=${DEBUG:-false}
      - RBAC_ENABLED=${RBAC_ENABLED:-true}
      
      # Jeturing CORE
      - JETURING_CORE_ENABLED=${JETURING_CORE_ENABLED:-true}
      - JETURING_CORE_URL=${JETURING_CORE_URL}
      - JETURING_CORE_API_KEY=${JETURING_CORE_API_KEY}
      
      # Microsoft 365
      - M365_TENANT_ID=${M365_TENANT_ID}
      - M365_CLIENT_ID=${M365_CLIENT_ID}
      - M365_CLIENT_SECRET=${M365_CLIENT_SECRET}
      
      # Tailscale
      - TAILSCALE_ENABLED=${TAILSCALE_ENABLED:-false}
      - TAILSCALE_AUTH_KEY=${TAILSCALE_AUTH_KEY}
      
      # HIBP
      - HIBP_API_KEY=${HIBP_API_KEY}
      - HIBP_ENABLED=${HIBP_ENABLED:-false}
      
      # Dehashed
      - DEHASHED_API_KEY=${DEHASHED_API_KEY}
      - DEHASHED_ENABLED=${DEHASHED_ENABLED:-false}
      
      # Database - PostgreSQL (production)
      - DATABASE_URL=postgresql+asyncpg://forensics:${DB_PASSWORD}@postgres:5432/forensics
      
      # Redis
      - REDIS_URL=redis://redis:6379/0
    
    volumes:
      # Source code (development mode - bind mount for hot reload)
      - ./api:/app/api:ro
      - ./core:/app/core:ro
      - ./scripts:/app/scripts:ro
      
      # Evidence storage (persistent)
      - evidence:/var/evidence
      
      # Logs (persistent)
      - logs:/var/log/mcp-forensics
      
      # Configuration (read-only)
      - ./config:/app/config:ro
    
    networks:
      - forensics-net
      - jeturing-core-net
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    cap_add:
      # Minimal capabilities for forensic analysis
      - NET_ADMIN
      - SYS_PTRACE
    
    security_opt:
      - no-new-privileges:true
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    labels:
      - "com.jeturing.service=mcp-forensics"
      - "com.jeturing.type=mcp"
      - "com.jeturing.version=4.4.1"
      - "com.jeturing.optimized=true"

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: mcp-forensics-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=forensics
      - POSTGRES_USER=forensics
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/backup_postgres.sh:/usr/local/bin/backup.sh:ro
    networks:
      - forensics-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forensics"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Redis for caching and task queues
  redis:
    image: redis:7-alpine
    container_name: mcp-forensics-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - forensics-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

volumes:
  evidence:
    driver: local
    driver_opts:
      type: none
      device: ${EVIDENCE_PATH:-./evidence}
      o: bind
  
  logs:
    driver: local
  
  postgres-data:
    driver: local
  
  redis-data:
    driver: local

networks:
  forensics-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  jeturing-core-net:
    external: true
    name: jeturing-core-network
